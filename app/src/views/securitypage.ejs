<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mes données</title>
    <link rel="stylesheet" href="../../static/css/securitypage.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  </head>
  <body>
    <div id="app">
      <%- include('partials/Header', { user: user }) %>
      <section class="user-profile">
        <div class="navigation-links">
          <a href="/profile" class="info profile">Mon profil</a>
          <a href="/infouser" class="infperso"
            >Informations <br />
            personnelles</a
          >
          <a href="/security" class="security">Sécurité</a>
          <a href="/forum" class="info">Forum</a>
        </div>
        <div class="infos-perso">
          <h1>securité</h1>
          <div class="line"></div>

          <div class="mdp-user">
            <p>Mot de passe</p>
            <p>************</p>
            <i
              id="edit-btn"
              class="fa-solid fa-pencil"
              style="color: #ffffff; font-size: 24px"
            ></i>
          </div>
          <div class="line"></div>
          <!-- 2FA toggle section -->
          <div class="2fa-toggle">
            <p>Activer 2FA</p>
            <label class="switch">
              <input type="checkbox" id="enable-2fa" <%= user.has_2_fa ?
              "checked" : "" %> />

              <span class="slider round"></span>
            </label>
          </div>
          <div class="line"></div>
        </div>
      </section>
      <div class="space-black"></div>
      <%- include('partials/Footer')%>
    </div>
    <!-- Import App -->
    <script src="/static/js/main.js"></script>
    <!-- Mount App -->
    <script>
      const mountedApp = app.mount("#app");
    </script>
  

    <script>


      document.addEventListener("DOMContentLoaded", () => {
        const enable2FAToggle = document.getElementById("enable-2fa");
        if (enable2FAToggle) {
          enable2FAToggle.addEventListener("change", () => {
            const enable2FA = enable2FAToggle.checked;
            const userId = "<%= user.user_id %>"; // Use the current user's ID

            fetch("/update-2fa", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                user_id: userId,
                enable_2fa: enable2FA, // Send the updated 2FA setting
              }),
            })
              .then((res) => res.json())
              .then((data) => {
                if (data.success) {
                  alert(
                    `2FA ${enable2FA ? "activé" : "désactivé"} avec succès !`
                  );
                } else {
                  alert("Erreur lors de la mise à jour de 2FA.");
                  enable2FAToggle.checked = !enable2FA; // Reset the toggle if failed
                }
              })
              .catch((err) => {
                console.error("Erreur:", err);
                alert("Erreur de connexion.");
                enable2FAToggle.checked = !enable2FA; // Reset the toggle if failed
              });
          });
        }
      });
    </script>
  </body>
</html>
